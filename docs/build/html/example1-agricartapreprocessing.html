

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Example 1 - Simple - Agricarta Preprocessing &mdash; Kube Docs 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example 2 - Simple - Landsat Downloader Service" href="example2-landsatdownloaderservice.html" />
    <link rel="prev" title="Kubernetes" href="kubernetes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Kube Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="kubernetes.html">Kubernetes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example 1 - Simple - Agricarta Preprocessing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-the-container">Build the Container</a></li>
<li class="toctree-l2"><a class="reference internal" href="#service">Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deployment">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configmaps">Configmaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#persistent-volume-and-claim">Persistent Volume and Claim</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-management-and-access">Data Management and Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="#flask-wrapper">Flask wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preprocessing-wrapper">Preprocessing Wrapper</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example2-landsatdownloaderservice.html">Example 2 - Simple - Landsat Downloader Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="example3-datacube.html">Example 3 - Complex - Datacube</a></li>
<li class="toctree-l1"><a class="reference internal" href="example4-tileviewerapi.html">Example 4 - Complex - Tile Viewer API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Kube Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Example 1 - Simple - Agricarta Preprocessing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/example1-agricartapreprocessing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="example-1-simple-agricarta-preprocessing">
<h1><a class="toc-backref" href="#id1">Example 1 - Simple - Agricarta Preprocessing</a><a class="headerlink" href="#example-1-simple-agricarta-preprocessing" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#example-1-simple-agricarta-preprocessing" id="id1">Example 1 - Simple - Agricarta Preprocessing</a></p>
<ul>
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p></li>
<li><p><a class="reference internal" href="#architecture" id="id3">Architecture</a></p></li>
<li><p><a class="reference internal" href="#prerequisites" id="id4">Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#build-the-container" id="id5">Build the Container</a></p></li>
<li><p><a class="reference internal" href="#service" id="id6">Service</a></p></li>
<li><p><a class="reference internal" href="#deployment" id="id7">Deployment</a></p></li>
<li><p><a class="reference internal" href="#configmaps" id="id8">Configmaps</a></p></li>
<li><p><a class="reference internal" href="#persistent-volume-and-claim" id="id9">Persistent Volume and Claim</a></p></li>
<li><p><a class="reference internal" href="#api" id="id10">API</a></p></li>
<li><p><a class="reference internal" href="#data-management-and-access" id="id11">Data Management and Access</a></p></li>
<li><p><a class="reference internal" href="#flask-wrapper" id="id12">Flask wrapper</a></p></li>
<li><p><a class="reference internal" href="#preprocessing-wrapper" id="id13">Preprocessing Wrapper</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id2">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>The first example is as simple as you can get for running an application on Kubernetes. We will have <a class="reference internal" href="kubernetes.html#pods-and-containers"><span class="std std-ref">one pod with one container</span></a>, <a class="reference internal" href="kubernetes.html#services"><span class="std std-ref">one service</span></a>, <a class="reference internal" href="kubernetes.html#configmaps"><span class="std std-ref">one configmap</span></a>, with a simple Flask web server wrapper around the application. Data will be stored on NFS <a class="reference internal" href="kubernetes.html#persistent-volumes-and-claims"><span class="std std-ref">persistent volumes</span></a> with a simple file to indicate processing status. Our input data is already stored on an NFS share, so we can mount that inside our pod. For future improvements, you could look to storing the data as S3 objects to make deployment to the cloud easier, in addition to leveraging GDAL’s ability to load from S3 data sources to make incremental networked file loads possible.</p>
</div>
<div class="section" id="architecture">
<h2><a class="toc-backref" href="#id3">Architecture</a><a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<img src="_images/mermaid-557cf44e2d1a6a4eba510f26cd8aee80ff3a1941.png" alt="graph TD
    A[POST request]-. /agricarta/preprocessing .-&gt;B[Ingress service]
    B -. job id .-&gt; A
    B &lt;--&gt; F
    D[NFS Persistent Volume] --&gt; F
    E[Configmap] --&gt; F

subgraph Pod
    F[Flask Web Server] --&gt; G[Agricarta]
end" />
</div>
<div class="section" id="prerequisites">
<h2><a class="toc-backref" href="#id4">Prerequisites</a><a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>Imagery data stored on an NFS network share that is accessible to our cluster. For this example we are going to create 2 NFS exports that will be used to store the data inputs and outputs. On the NFS server, you will need to create the directory, edit the /etc/exports file, and restart the nfs-kernel-server. There will also be datasets required for processing that we will mount from a NFS share. All of these shares will be mounted using persistent volume claims inside the container.</p>
<p>You can verify the new mounts are accessible by running <code class="code docutils literal notranslate"><span class="pre">showmount</span> <span class="pre">-e</span> <span class="pre">&lt;NFS</span> <span class="pre">server</span> <span class="pre">IP&gt;</span></code> from the cluster node machines.</p>
</div>
<div class="section" id="build-the-container">
<h2><a class="toc-backref" href="#id5">Build the Container</a><a class="headerlink" href="#build-the-container" title="Permalink to this headline">¶</a></h2>
<p>Here’s the Dockerfile we will use:</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">ubuntu:18.04</span>

<span class="k">COPY</span> ./requirements.txt /code/requirements.txt

<span class="k">WORKDIR</span><span class="s"> /code</span>

<span class="k">RUN</span> apt update

<span class="k">RUN</span> apt install -y software-properties-common build-essential

<span class="k">RUN</span> apt-add-repository -y ppa:deadsnakes/ppa

<span class="k">RUN</span> apt update

<span class="k">RUN</span> apt install -y python3.7 python3.7-dev python3.7-venv python3-pip zlib1g zlib1g-dev libpng-dev libjpeg-dev

<span class="k">RUN</span> python3.7 -m pip install --upgrade pip
<span class="k">RUN</span> python3.7 -m pip install numpy
<span class="k">RUN</span> apt install -y gdal-bin gdal-data libgdal-dev

<span class="k">RUN</span> python3.7 -m pip install <span class="nv">gdal</span><span class="o">==</span><span class="sb">`</span>gdal-config --version<span class="sb">`</span> --global-option<span class="o">=</span>build_ext --global-option<span class="o">=</span><span class="s2">&quot;-I/usr/include/gdal/&quot;</span>

<span class="k">RUN</span> python3.7 -m pip install -r /code/requirements.txt

<span class="k">COPY</span> . /code

<span class="k">EXPOSE</span><span class="s"> 5000</span>

<span class="c">#CMD [&quot;gunicorn&quot;, &quot;--bind&quot;, &quot;0.0.0.0:5000&quot;, &quot;--log-level=debug&quot;, &quot;jobmanager.wsgi&quot;]</span>
</pre></div>
</div>
</div>
<div class="section" id="service">
<h2><a class="toc-backref" href="#id6">Service</a><a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h2>
<p>For the service we will use a Nodeport, but if we had easy access to creating DNS entries, an Ingress would be preferable.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta-nodeport</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta</span>
<span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">protocol</span><span class="p">:</span> <span class="s">&quot;TCP&quot;</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5000</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5000</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30199</span>
<span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
</pre></div>
</div>
</div>
<div class="section" id="deployment">
<h2><a class="toc-backref" href="#id7">Deployment</a><a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>The important parts of the deployment are the single container, which starts our Flask server, and the volume mounts, one for the NFS that our imagery is mounted on, and one for the configmap that stores our generic config options.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta</span>
<span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
    <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta</span>
    <span class="nt">spec</span><span class="p">:</span>
    <span class="nt">containers</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">registry.kub-eo.agr.gc.ca/agricarta:v0.0.2</span>
        <span class="nt">env</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FLASK_APP</span>
            <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">server.py</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FLASK_DEBUG</span>
            <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
        <span class="nt">command</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;flask&quot;</span><span class="p p-Indicator">]</span> <span class="c1"># env FLASK_APP=server.py FLASK_DEBUG=1 flask run --host 0.0.0.0</span>
        <span class="nt">args</span><span class="p">:</span>
            <span class="p p-Indicator">[</span>
            <span class="s">&quot;run&quot;</span><span class="p p-Indicator">,</span>
            <span class="s">&quot;--host&quot;</span><span class="p p-Indicator">,</span>
            <span class="s">&quot;0.0.0.0&quot;</span>
            <span class="p p-Indicator">]</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5000</span>
            <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs-miniostorage-volume</span>
            <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code/miniostorage</span>
            <span class="p p-Indicator">-</span> <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code/config.yaml</span>
            <span class="nt">subPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config.yaml</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta-preprocessing-config-volume</span>
    <span class="nt">imagePullSecrets</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">regcred</span>
    <span class="nt">volumes</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs-miniostorage-volume</span>
        <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
            <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs-pvc-miniostorage</span>
        <span class="p p-Indicator">-</span> <span class="nt">configMap</span><span class="p">:</span>
            <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta-preprocessing-config</span>
            <span class="nt">items</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config.yaml</span>
                <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config.yaml</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agricarta-preprocessing-config-volume</span>
</pre></div>
</div>
</div>
<div class="section" id="configmaps">
<h2><a class="toc-backref" href="#id8">Configmaps</a><a class="headerlink" href="#configmaps" title="Permalink to this headline">¶</a></h2>
<p>For the configmap, we are using a config.yaml file for the generic options, and the specific job options will be set by a JSON object in the POST request for our API.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">ROOT_DIR</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code</span>
<span class="c1"># WORKING_DIR: /code/workingdir</span>
<span class="nt">DEPENDENCIES_DIR</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code/miniostorage/required_datasets</span>
<span class="nt">SRTM_DIR</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code/miniostorage/required_datasets/dem/SRTM41</span>
<span class="nt">IMAGERY_STORAGE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/code/miniostorage</span>
<span class="c1"># RESOLUTION: 10</span>
<span class="c1"># CPU_CORES: 6</span>
<span class="c1"># LOGGING_DIR: /code/logs</span>
<span class="nt">LOGGING_CONFIG</span><span class="p">:</span>
<span class="nt">console_level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DEBUG</span>
<span class="nt">file_level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DEBUG</span>
<span class="c1"># DELETE_INTERMEDIATE: True</span>

<span class="c1"># Projection as PROJ4 string as string</span>
<span class="nt">PROJECTION</span><span class="p">:</span> <span class="s">&quot;+proj=aea</span><span class="nv"> </span><span class="s">+lat_1=44.75</span><span class="nv"> </span><span class="s">+lat_2=55.75</span><span class="nv"> </span><span class="s">+lat_0=40</span><span class="nv"> </span><span class="s">+lon_0=-96</span><span class="nv"> </span><span class="s">+x_0=0</span><span class="nv"> </span><span class="s">+y_0=0</span><span class="nv"> </span><span class="s">+ellps=WGS84</span><span class="nv"> </span><span class="s">+datum=WGS84</span><span class="nv"> </span><span class="s">+units=m</span><span class="nv"> </span><span class="s">+no_defs&quot;</span>

<span class="c1"># Imagery System Parameters</span>
<span class="c1"># NOTE: Custom parameters can be defined. Bellow is an example of the defaults</span>
<span class="c1"># System will use defaults if &#39;params&#39; NOT defined within this file</span>
<span class="c1">#      LC8 &#39;products&#39; --&gt; dn = Digital Number</span>
<span class="c1">#                         radiance = Spectral Radiance</span>
<span class="c1">#                         sr = Surface Reflectance</span>
<span class="c1">#                         toa = Top of Atmosphere Reflectance</span>
<span class="c1">#      RCM / RS2 &#39;filter&#39; --&gt; gamma = Gamma Filter</span>
<span class="c1">#      RCM / RS2 &#39;modes&#39;  --&gt; W2 = Wide Beam #2</span>
<span class="c1">#      RCM / RS2 &#39;units&#39;  --&gt; amp = Amplitude</span>
<span class="c1">#                             dB = Decibel</span>
<span class="c1">#                             pow = Power</span>
<span class="nt">PARAMS</span><span class="p">:</span>
<span class="nt">LC8</span><span class="p">:</span>
    <span class="nt">bands</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B2</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B3</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B4</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B5</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B6</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B7</span>
    <span class="nt">product</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sr</span>
    <span class="nt">resamp_clip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
<span class="nt">RCM</span><span class="p">:</span>
    <span class="nt">bands</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CH</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CV</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">HH</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">HV</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">VH</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">VV</span>
<span class="nt">RS2</span><span class="p">:</span>
    <span class="nt">filter</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gamma</span>
    <span class="nt">modes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">W2</span>
<span class="nt">S2</span><span class="p">:</span>
    <span class="nt">bands</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B02</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B03</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B04</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B05</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B8A</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B11</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">B12</span>
    <span class="nt">resamp_clip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>
</div>
<p>The command we use to create the configmap from the config.yaml file is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl create configmap agricarta-preprocessing-config --from-file config.yaml
</pre></div>
</div>
</div>
<div class="section" id="persistent-volume-and-claim">
<h2><a class="toc-backref" href="#id9">Persistent Volume and Claim</a><a class="headerlink" href="#persistent-volume-and-claim" title="Permalink to this headline">¶</a></h2>
<p>The persistent volume is a NFS share that we have access to inside the cluster and out, so we can mount it as a regular network share in addition to using it as a persistent volume.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs-pv-miniostorage</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">capacity</span><span class="p">:</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10Ti</span>
<span class="nt">accessModes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
<span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Retain</span>
<span class="nt">nfs</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/mnt/md0/minio_storage</span>
    <span class="nt">server</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.117.206.94</span>
    <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs-pvc-miniostorage</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">accessModes</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
<span class="nt">resources</span><span class="p">:</span>
    <span class="nt">requests</span><span class="p">:</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10Ti</span>
</pre></div>
</div>
</div>
<div class="section" id="api">
<h2><a class="toc-backref" href="#id10">API</a><a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>The Nodeport service means our API is accessible on port <code class="code docutils literal notranslate"><span class="pre">30199</span></code> on the node through the nodes’ hostnames or IP addresses. The end point is <code class="code docutils literal notranslate"><span class="pre">/agricarta/preprocessing</span></code>, it supports the POST HTTP method, and the processing parameters are JSON data that you include with the POST request.</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>

    <span class="nt">&quot;imagery_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LC08_L1TP_015028_20200814_20200822_01_T1&quot;</span><span class="p">,</span> <span class="s2">&quot;LC08_L1TP_015029_20200814_20200822_01_T1&quot;</span><span class="p">],</span>

    <span class="nt">&quot;resolution&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>

    <span class="nt">&quot;cores&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>

    <span class="nt">&quot;delete_intermediate&quot;</span><span class="p">:</span> <span class="kc">false</span>

<span class="p">}</span>
</pre></div>
</div>
<p>We can use Postman to test our API.</p>
</div>
<div class="section" id="data-management-and-access">
<h2><a class="toc-backref" href="#id11">Data Management and Access</a><a class="headerlink" href="#data-management-and-access" title="Permalink to this headline">¶</a></h2>
<p>Because we have access to the NFS share with the imagery we are using, we can use the NFS share to host the preprocessing results. Thus the results are acessible on the NFS share and the S3 Minio instance that NFS share is also backing.</p>
</div>
<div class="section" id="flask-wrapper">
<h2><a class="toc-backref" href="#id12">Flask wrapper</a><a class="headerlink" href="#flask-wrapper" title="Permalink to this headline">¶</a></h2>
<p><code class="code docutils literal notranslate"><span class="pre">server.py</span></code> is a Flask web server instance that we use to control our application. We run the server in our container with the command <code class="code docutils literal notranslate"><span class="pre">flask</span> <span class="pre">run</span> <span class="pre">--host</span> <span class="pre">0.0.0.0</span></code> as seen above in our deployment definition.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>

<span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello, World!&quot;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/agricarta/preprocessing&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">json</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>

        <span class="n">job_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>

        <span class="c1"># example sub process command</span>
        <span class="c1"># python3.7 server_preprocessing.py</span>
        <span class="c1"># LC08_L1TP_042025_20200624_20200707_01_T1 LC08_L1TP_042026_20200624_20200707_01_T1 /code/workingdir config.yaml UNIQUEJOBID 10 4 True</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;python3.7&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;server_preprocessing.py&quot;</span><span class="p">,</span>
                                    <span class="o">*</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;imagery_list&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;/code/workingdir&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;config.yaml&quot;</span><span class="p">,</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;cores&quot;</span><span class="p">]),</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;delete_intermediate&quot;</span><span class="p">])])</span>

    <span class="c1"># the code below is executed if the request method</span>
    <span class="c1"># was GET or the credentials were invalid</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="preprocessing-wrapper">
<h2><a class="toc-backref" href="#id13">Preprocessing Wrapper</a><a class="headerlink" href="#preprocessing-wrapper" title="Permalink to this headline">¶</a></h2>
<p>We need to create a preprocessing wrapper that calls the Agricarta preprocessing module which accepts command line args and can read our general <code class="code docutils literal notranslate"><span class="pre">config.yaml</span></code> configuration file.</p>
<p><code class="code docutils literal notranslate"><span class="pre">preprocessing_server.py</span></code> is similar to the 1_preprocessing.py executor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tarfile</span>

<span class="kn">import</span> <span class="nn">agricarta</span> <span class="k">as</span> <span class="nn">ag</span>
<span class="kn">from</span> <span class="nn">utilities.common</span> <span class="kn">import</span> <span class="n">ConfigFileProblem</span><span class="p">,</span> <span class="n">ConfigValueMissing</span>

<span class="n">REQUIRED_CONFIG_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;ROOT_DIR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IMAGERY_STORAGE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DEPENDENCIES_DIR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SRTM_DIR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOGGING_CONFIG&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PROJECTION&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PARAMS&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;imagery_names&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;working_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;job_id&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;cores&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s1">&#39;delete_intermediate&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">imagery_names</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">delete_intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">job_result_log</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Load config from config.yaml</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Problem loading config... exiting...&quot;</span><span class="p">)</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Problem loading config&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing config file with path </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing config file&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown problem occurred while loading config&quot;</span><span class="p">)</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Problem occurred while loading config&quot;</span><span class="p">)</span>

    <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imagery names: </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imagery_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job id: </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working dir: </span><span class="si">{</span><span class="n">working_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolution: </span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delete intermediate: </span><span class="si">{</span><span class="n">delete_intermediate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cores: </span><span class="si">{</span><span class="n">cores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">JOB_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="n">IMAGERY_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">JOB_DIR</span><span class="p">,</span> <span class="s1">&#39;imagery&#39;</span><span class="p">)</span>
    <span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">JOB_DIR</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">JOB_DIR</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">IMAGERY_DIR</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>

    <span class="c1"># Before this is called, make sure all the appropriate folders are created based on the job id</span>
    <span class="c1"># 1. Create &#39;imagery&#39; dir, &#39;output_dir&#39;, inside &#39;job_id&#39; dir</span>
    <span class="c1"># 2. Copy image from imagery storage based on the image type</span>
    <span class="c1"># 3. Once all imagery is found, run the preprocessing module</span>

    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">imagery_names</span><span class="p">:</span>
        <span class="c1"># Determine image type</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;LC08&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Landsat image&#39;</span><span class="p">)</span>
            <span class="n">pathrow</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">pathrow</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">pathrow</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;IMAGERY_STORAGE&#39;</span><span class="p">],</span> <span class="s2">&quot;l8-l2a-products&quot;</span><span class="p">,</span> <span class="s2">&quot;tiles&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">image_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image exists&#39;</span><span class="p">)</span>
                <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image: </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> FOUND&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">IMAGERY_DIR</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image copied&quot;</span><span class="p">)</span>
                <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image: </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> COPIED&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">IMAGERY_DIR</span><span class="p">,</span> <span class="n">image</span> <span class="o">+</span> <span class="s1">&#39;.tar.gz&#39;</span><span class="p">),</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">IMAGERY_DIR</span><span class="p">,</span> <span class="n">image</span><span class="p">),</span> <span class="n">arcname</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;imagery not found&quot;</span><span class="p">)</span>
                <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Image: </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> NOT FOUND&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Preprocessing started&#39;</span><span class="p">)</span>
        <span class="n">ag</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">process_multiple_images</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">IMAGERY_DIR</span><span class="p">)],</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="s2">&quot;preprocess&quot;</span><span class="p">)),</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)),</span>
                                                <span class="n">params</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PARAMS&#39;</span><span class="p">],</span>
                                                <span class="n">output_projection</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROJECTION&#39;</span><span class="p">],</span>
                                                <span class="n">output_resolution</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">resolution</span><span class="p">),</span>
                                                <span class="n">align_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">srtm_path</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SRTM_DIR&#39;</span><span class="p">],</span>
                                                <span class="n">required_datasets</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DEPENDENCIES_DIR&#39;</span><span class="p">],</span>
                                                <span class="n">delete_intermediate</span><span class="o">=</span><span class="n">delete_intermediate</span><span class="p">,</span>
                                                <span class="n">log_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">ncores</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;|       EXCEPTION      |: Encountered a generic exception at preprocessing task &#39;</span>
                    <span class="s1">&#39;scheduler. Details: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Exception occured, preprocessing failed&quot;</span><span class="p">)</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">job_result_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Preprocessing finished&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">JOB_DIR</span><span class="p">,</span> <span class="s2">&quot;job_log.txt&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_result_log</span><span class="p">))</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">IMAGERY_DIR</span><span class="p">)</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">JOB_DIR</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;IMAGERY_STORAGE&quot;</span><span class="p">],</span> <span class="s2">&quot;agricarta&quot;</span><span class="p">,</span> <span class="s2">&quot;preprocessing&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="example2-landsatdownloaderservice.html" class="btn btn-neutral float-right" title="Example 2 - Simple - Landsat Downloader Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="kubernetes.html" class="btn btn-neutral float-left" title="Kubernetes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Shaun Cullen

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>